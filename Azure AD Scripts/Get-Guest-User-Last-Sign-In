<#
    Author: Sean McAvinue
    Contact: Sean@seanmcavinue., Twitter: @Sean_McAvinue
    Update by Chris Blackburn, http://github.com/thetootall
    .SYNOPSIS
    Gets guest users last sign in action from AAD logs and exports user and signin list to CSV in C:\temp
    https://seanmcavinue.net/2020/12/11/quick-and-easy-powershell-report-for-azure-ad-guest-user-last-sign-in/

#>
try 
{ $var = Get-AzureADTenantDetail } 
catch [Microsoft.Open.Azure.AD.CommonLibrary.AadNeedAuthenticationException] 
{ Write-Host "You're not connected - authenticating to Azure AD..." -ForegroundColor Black -BackgroundColor Yellow
Connect-AzureAD
}
##Get all guest users
$guests = Get-AzureADUser -Filter "userType eq 'Guest'" -All $true | Sort-object Displayname

##Loop Guest Users
foreach ($guest in $guests) {

    ##Get logs filtered by current guest
    $logs = Get-AzureADAuditSignInLogs -Filter "userprincipalname eq `'$($guest.mail)'" -ALL:$true 

        $timestamp = $logs.createddatetime
        If ($timestamp -eq $NULL){
        $timestamp = "BLANK"}
        Else
        {$timestamp = $logs[0].createddatetime}

    ##Build Output Object
    $exuser = $guest.extensionproperty
    $object = [PSCustomObject]@{

        Userprincipalname = $guest.userprincipalname
        UserState = $guest.UserState
        Enabled = $guest.AccountEnabled
        Name = $guest.DisplayName
        Mail = $guest.mail
        CreatedDate = $exuser.createdDateTime
        LastSignin = $timestamp
        AppsUsed = (($logs.resourcedisplayname | select -Unique) -join (';'))
    }

    ##Export Results
    Write-host $object
    $object | export-csv AndersenGuestUserSignins.csv -NoTypeInformation -Append

    Clear-Variable object
    Clear-Variable logs
    Clear-Variable timestamp
    Clear-Variable exuser

}
